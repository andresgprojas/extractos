<?php

require_once '../cab.inc.php';
extract($_POST);

if(!$_POST){
        die('0');//no hacer nada
}

switch ($action) {
    case 'Subir al Servidor':
        
        $Con = new Conn();
        $Con->conectar();
        $sesion = $Con->getSesion();
        
        if ($sesion === FALSE)
            die('0');
        
        
        if (!$_FILES)
            die('Es obligatorio seleccionar un archivo');

        if ($_FILES['myFile']['type'] == 'text/csv'){
            $ok = TRUE;
            $fp = fopen ( $_FILES['myFile']['tmp_name'], "r" );
            
            mysqli_autocommit($Con->getLink(), FALSE);
            while (( $data = fgetcsv ( $fp , 2048, ";" )) !== false ) { // Mientras hay líneas que leer...

                if ($data[0] === "1"){//datos del usuario
                    $nombre     = $data[4];//nombre
                    $direccion  = $data[5];//direccion
                    $ciudad     = $data[7];//ciudad
                    $pais       = $data[8];//pais
                    $CC         = (int)$data[10];//cedula
                    $saldoAnt   = $data[11];//saldo Anterior
                    
                    $Usuario = new Usuario();
                    $rta = $Usuario->getByFilter($Con, array('Nuip'=>$CC));
                    if ($rta === FALSE){//si no existe el usuario
                        $Usuario->setNuip($CC);
                        $Usuario->setCiudad($ciudad);
                        $Usuario->setDireccion($direccion);
                        $Usuario->setPais($pais);
                        $Usuario->setPrimerNom($nombre);
                        if (!$Usuario->setUsuario($Con)){
//                            echo "a";
                            $ok=FALSE;
                            break;
                        }
                        
                        $Login = new Login();
                        $Login->setPassword(md5($CC));
                        $Login->setUsuarioNuip($CC);
                        if (!$Login->setLogin($Con)){
//                            echo "b";
                            $ok=FALSE;
                            break;
                        }
                    }

                }
                elseif($data[0] === "2"){
                    $fecha      = $data[1];//fecha
                    $documento  = $data[2];//documento
                    $numero     = $data[3];//numero
                    $transaccion= $data[4];//transaccion
                    $detalle    = $data[5]. " ".$data[6]. " ". $data[7];//detalle
                    $debito     = $data[9];//debito
                    $credito    = $data[10];//credito
                    $saldo      = $data[11];//
                    
                    $Documento = new Documento();
                    $rtaDoc = $Documento->getByFilter($Con, array('Alias'=>$documento));
                    
                    if ($rtaDoc === FALSE){
                        $Documento->setAlias($documento);
                        $Documento->setNombre($documento);
                        $idDoc = $Documento->setDocumento($Con);
                    }
                    else{
                        $idDoc = $rtaDoc[0]->getId();//obtener documento id
                    }
                    
                    $rtaTrn = $Documento->getByFilter($Con, array('Alias'=>$transaccion));
                    if ($rtaTrn === FALSE){
                        $Documento->setAlias($transaccion);
                        $Documento->setNombre($transaccion);
                        $idTrn = $Documento->setDocumento($Con);
                    }
                    else{
                        $idTrn = $rtaTrn[0]->getId();//obtener documento id
                    }
                    
                    $Rubros = new Rubros();
                    $Rubros->setCredito($credito);
                    $Rubros->setDetalle($detalle);
                    $Rubros->setDebito($debito);
                    $Rubros->setDocumentoId($idDoc);
                    $Rubros->setFechaDocumento($fecha);
                    $Rubros->setNumero($numero);
                    $Rubros->setSaldo($saldo);
                    $Rubros->setTransaccionId($idTrn);
                    $Rubros->setUsuarioNuip($CC);

                    if (!$Rubros->setRubro($Con)){
//                        echo "c";
                        $ok=FALSE;
                        break;
                    }
                    
                }


            } 
            
            if($ok===TRUE){
                mysqli_commit($Con->getLink());
                printf(utf8_encode("Archivo Cargado Satisfactoriamente"));
            }else{
                mysqli_rollback($Con->getLink());
                printf(utf8_encode("Hubo un error Al cargar el archivo"));
            }
            
            fclose ( $fp );
            
            
        }else{
            printf('El archivo que intenta cargar no es un CSV');
        }
        
        
        
        $Con->cerrar();
        break;

    default:
        break;
}
die();
?>
